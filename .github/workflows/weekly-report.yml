name: Haftalik Aktivite Raporu

on:
  schedule:
    - cron: '0 14 * * 5'  # Her Cuma 17:00 TR (14:00 UTC)
  workflow_dispatch:        # Manuel tetikleme

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Haftalik Rapor Olustur
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO="${{ github.repository }}"
          SINCE=$(date -d '7 days ago' --iso-8601)
          TODAY=$(date --iso-8601)

          # Commit sayisi
          COMMIT_COUNT=$(git log --since="$SINCE" --oneline 2>/dev/null | wc -l)

          # Contributor listesi
          CONTRIBUTORS=$(git log --since="$SINCE" --format='%an' 2>/dev/null | sort -u | tr '\n' ', ' | sed 's/,$//')

          # Acilan PR sayisi
          PR_OPENED=$(gh pr list --repo "$REPO" --state all --search "created:>=$SINCE" --json number --jq 'length' 2>/dev/null || echo "0")

          # Merge edilen PR sayisi
          PR_MERGED=$(gh pr list --repo "$REPO" --state merged --search "merged:>=$SINCE" --json number --jq 'length' 2>/dev/null || echo "0")

          # Acik issue sayisi
          OPEN_ISSUES=$(gh issue list --repo "$REPO" --state open --json number --jq 'length' 2>/dev/null || echo "0")

          # Rapor metni
          REPORT="üìä *Haftalik Rapor: ${REPO#*/}*\nüìÖ $SINCE ‚Üí $TODAY\n\n"
          REPORT+="üìù Commit: $COMMIT_COUNT\n"
          REPORT+="üîÄ PR Acilan: $PR_OPENED | Merge: $PR_MERGED\n"
          REPORT+="üìã Acik Issue: $OPEN_ISSUES\n"

          if [ -n "$CONTRIBUTORS" ]; then
            REPORT+="üë• Katkilar: $CONTRIBUTORS\n"
          fi

          if [ "$COMMIT_COUNT" -eq 0 ] && [ "$PR_OPENED" -eq "0" ]; then
            REPORT+="\n‚ö†Ô∏è Bu hafta bu repoda aktivite yok."
          fi

          echo "Rapor:"
          echo -e "$REPORT"

          # Slack'e gonder
          curl -s -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ secrets.SLACK_DEV_CHANNEL_ID }}\",
              \"text\": \"$REPORT\"
            }"